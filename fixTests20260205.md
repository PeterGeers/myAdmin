# Test Failures - February 5, 2026

## Summary

3 unit tests failing after template field mapping changes:

1. `test_approve_template_with_field_mappings` - Field mapping structure mismatch
2. `test_render_template_with_number_formatting` - Missing thousands separator
3. `test_render_template_with_large_numbers` - Missing thousands separator

## Details

### 1. test_approve_template_with_field_mappings

**File**: `tests/unit/test_template_approval.py:301`

**Issue**: The test expects old field mapping format (simple key-value pairs) but code now uses new structured format with `fields`, `conditionals`, `formatting`.

**Expected (old format)**:

```python
{
    'amount_gross': 'total_amount',
    'guest_name': 'booking_guest_name',
    'invoice_number': 'custom_invoice_field'
}
```

**Actual (new format)**:

```python
{
    'fields': {
        'amount_gross': {
            'default': 0,
            'format': 'currency',
            'path': 'amount_gross',
            'source': 'database',
            'transform': 'round'
        },
        # ... more fields
    },
    'conditionals': [...],
    'formatting': {
        'currency': 'EUR',
        'date_format': 'DD-MM-YYYY',
        'locale': 'en_US',
        'number_decimals': 2
    }
}
```

**Fix**: Update test to expect new field mapping structure.

### 2. test_render_template_with_number_formatting

**File**: `tests/unit/test_template_rendering.py:108`

**Issue**: Number formatting not applying thousands separators.

**Expected**: `1,234.56`
**Actual**: `1234.56`

**Fix**: Implement or fix number formatting in template rendering service.

### 3. test_render_template_with_large_numbers

**File**: `tests/unit/test_template_rendering.py:394`

**Issue**: Same as #2 - thousands separators not applied.

**Expected**: `1,234,567.89`
**Actual**: `1234567.89`

**Fix**: Same as #2.
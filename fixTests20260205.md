# Test Fixes - February 5, 2026

## Summary

Fixed hanging test issues in authentication test files by adding proper `authService` mocks. Identified that `AuthContext.test.tsx` still needs fixing based on full test suite run.

## Build Test Results (Full Suite)

**Command**: `.\scripts\CICD\build.ps1`

**Results**:

- ✅ npm ci (frontend dependencies) - 1m 26s
- ✅ ESLint (frontend linting) - 26s (174 warnings, 0 errors)
- ❌ Frontend tests (Jest) - **66m 20s** (TIMEOUT/HANG)

**Tests that passed before hang**:

- ✅ app.errorBoundary.test.tsx
- ✅ app.loading.test.tsx
- ✅ components/reports/BnbReportsGroup.test.tsx
- ✅ tests/simple-routing.test.js
- ✅ components/ViolinChart.test.tsx
- ✅ components/ProtectedRoute.test.tsx
- ✅ services/tenantApiService.test.ts
- ✅ components/UnifiedAdminYearFilter.integration.test.tsx
- ✅ tests/api-alignment.test.ts
- ✅ app.theme.test.tsx

**Conclusion**: Tests are still hanging after 66 minutes, indicating there's at least one more test file with the same `authService` mocking issue.

**Build Error After Tests**:

```
❌ Failed: Frontend production build (React) (took 3m 13s)

TS2304: Cannot find name 'isAuthenticatedSpy'.
  69 |   mockFetchAuthSession.mockRejectedValue(new Error('Not authenticated'));
  70 |   (authService.isAuthenticated as jest.Mock).mockResolvedValue(false);
> 71 |   (authService.getCurrentAuthTokens as jest.Mock).mockResolvedValue(null);
     |     ^^^^^^^^^^^^^^^^^^
  72 |   (authService.getCurrentUserRoles as jest.Mock).mockResolvedValue([]);
  73 |   (authService.getCurrentUserEmail as jest.Mock).mockResolvedValue(null);
  74 |   (authService.getCurrentUserName as jest.Mock).mockResolvedValue(null);
```

**Root Cause**: `AuthContext.test.tsx` still references undefined spy variables (`isAuthenticatedSpy`, `getCurrentUserRolesSpy`, `getCurrentUserEmailSpy`) that were removed when we added the proper mocks. This causes TypeScript compilation to fail.

## Files Fixed

### 1. `frontend/src/tests/authentication-flow.test.tsx` ✅

**Problem**: Tests were hanging when run as part of the full test suite because `AuthContext` was calling unmocked `authService` functions, causing infinite loops.

**Solution**:

- Added `authService` mock at the top of the file
- Created `setupAuthenticatedMocks()` helper function
- Created `setupUnauthenticatedMocks()` helper function
- Added default mocks in `beforeEach()` to prevent hanging
- Updated all 11 tests to use the helper functions

**Results**: ✅ All 11 tests passing (3.746s)

**Git Commit**: `ec8943c` - Fix authentication-flow.test.tsx hanging issue - add authService mocks

### 2. `frontend/src/__tests__/authentication.integration.test.tsx` ✅

**Status**: ✅ Already fixed (from previous session - Feb 4)

**Results**: ✅ All 20 tests passing (3.337s)

**Git Commit**: `37859a2` - Previous authentication.integration.test.tsx fixes

### 3. `frontend/src/context/AuthContext.test.tsx` ⏳ IN PROGRESS

**Problem**: Uses `jest.spyOn()` instead of properly mocking the `authService` module, causing the real functions to be called and creating infinite loops.

**Current Status**:

- ✅ Added `authService` mock module
- ✅ Added `fetchAuthSession` import
- ✅ Created helper functions `setupAuthenticatedMocks()` and `setupUnauthenticatedMocks()`
- ✅ Updated `beforeEach()` with default mocks
- ❌ Tests still reference old spy variables (`isAuthenticatedSpy`, `getCurrentUserRolesSpy`, `getCurrentUserEmailSpy`)
- ❌ Need to update all 7 tests to use helper functions instead of spies

**Tests in file**:

1. should throw error when useAuth is used outside AuthProvider
2. should show loading state initially
3. should show not authenticated when user is not logged in
4. should load user data when authenticated
5. should handle authentication errors gracefully
6. should handle logout
7. should check roles correctly

**Next Steps**:

- Remove old spy variable references
- Update each test to use `setupAuthenticatedMocks()` or `setupUnauthenticatedMocks()`
- Test individually to verify no hanging
- Commit changes

## Test Results Summary

### Individual Test Files (Verified)

- `authentication.integration.test.tsx`: 20/20 passed ✅
- `authentication-flow.test.tsx`: 11/11 passed ✅
- `AuthContext.test.tsx`: ⏳ In progress

### Full Test Suite

- ❌ Hangs after ~66 minutes
- Likely cause: `AuthContext.test.tsx` or other test files using `AuthContext`

## Pattern for Fixing Hanging Tests

If a test file uses `AuthContext` or `authService`, add these mocks:

```typescript
import * as authService from "../services/authService";
import { getCurrentUser, signOut, fetchAuthSession } from "aws-amplify/auth";

// Mock AWS Amplify
jest.mock("aws-amplify/auth");

// Mock authService to prevent infinite loops in AuthContext
jest.mock("../services/authService", () => ({
  isAuthenticated: jest.fn(),
  getCurrentAuthTokens: jest.fn(),
  getCurrentUserRoles: jest.fn(),
  getCurrentUserEmail: jest.fn(),
  getCurrentUserName: jest.fn(),
  getCurrentUserTenants: jest.fn(),
  hasRole: jest.fn(),
  hasAnyRole: jest.fn(),
  hasAllRoles: jest.fn(),
}));

// Create mock token helper
const createMockToken = (email: string, groups: string[]) => {
  const payload = {
    email: email,
    "cognito:groups": groups,
    exp: Math.floor(Date.now() / 1000) + 3600,
    iat: Math.floor(Date.now() / 1000),
  };
  const encodedPayload = btoa(JSON.stringify(payload));
  return `header.${encodedPayload}.signature`;
};

const createMockSession = (token: string) => ({
  tokens: {
    idToken: { toString: () => token },
    accessToken: { toString: () => token },
  },
});

// Add helper functions
const setupAuthenticatedMocks = (user, token, roles) => {
  (getCurrentUser as jest.Mock).mockResolvedValue(user);
  (fetchAuthSession as jest.Mock).mockResolvedValue(createMockSession(token));
  (authService.isAuthenticated as jest.Mock).mockResolvedValue(true);
  (authService.getCurrentUserEmail as jest.Mock).mockResolvedValue(
    user.signInDetails?.loginId || user.username,
  );
  (authService.getCurrentUserName as jest.Mock).mockResolvedValue(
    user.username,
  );
  (authService.getCurrentUserRoles as jest.Mock).mockResolvedValue(roles);
  (authService.getCurrentUserTenants as jest.Mock).mockResolvedValue([
    "tenant1",
  ]);
  (authService.getCurrentAuthTokens as jest.Mock).mockResolvedValue({
    idToken: token,
    accessToken: token,
  });
  (authService.hasRole as jest.Mock).mockImplementation(
    (userRoles: string[], requiredRole: string) => roles.includes(requiredRole),
  );
};

const setupUnauthenticatedMocks = () => {
  (fetchAuthSession as jest.Mock).mockRejectedValue(
    new Error("Not authenticated"),
  );
  (authService.isAuthenticated as jest.Mock).mockResolvedValue(false);
  (authService.getCurrentAuthTokens as jest.Mock).mockResolvedValue(null);
  (authService.getCurrentUserRoles as jest.Mock).mockResolvedValue([]);
  (authService.getCurrentUserEmail as jest.Mock).mockResolvedValue(null);
  (authService.getCurrentUserName as jest.Mock).mockResolvedValue(null);
  (authService.getCurrentUserTenants as jest.Mock).mockResolvedValue([]);
};

// In beforeEach, set default mocks
beforeEach(() => {
  jest.clearAllMocks();
  (authService.isAuthenticated as jest.Mock).mockResolvedValue(false);
  (authService.getCurrentAuthTokens as jest.Mock).mockResolvedValue(null);
  (authService.getCurrentUserRoles as jest.Mock).mockResolvedValue([]);
  (authService.getCurrentUserEmail as jest.Mock).mockResolvedValue(null);
  (authService.getCurrentUserName as jest.Mock).mockResolvedValue(null);
  (authService.getCurrentUserTenants as jest.Mock).mockResolvedValue([]);
});
```

## Next Steps

1. ✅ Fix `AuthContext.test.tsx` - update all 7 tests to use helper functions
2. Test `AuthContext.test.tsx` individually
3. Run full test suite again to see if there are other hanging tests
4. Apply same pattern to any other failing test files
5. Run CI/CD pipeline once all tests pass

## Git Commits

- `ec8943c` - Fix authentication-flow.test.tsx hanging issue - add authService mocks
- `37859a2` - Previous authentication.integration.test.tsx fixes
- (pending) - Fix AuthContext.test.tsx hanging issue - add authService mocks

# Fix Authentication Integration Tests - Task List

**Date:** February 4, 2026  
**File:** `frontend/src/__tests__/authentication.integration.test.tsx`  
**Issue:** Tests hanging due to improper mocking of authService functions

## Problem Summary

The `AuthContext` calls `authService` functions which weren't properly mocked, causing infinite loops when checking authentication state. Tests would hang indefinitely, particularly in the "Protected Routes" section.

## Solution

Use helper functions `setupAuthenticatedMocks()` and `setupUnauthenticatedMocks()` consistently across all tests to ensure proper mocking of both AWS Amplify functions and authService wrapper functions.

---

## ‚úÖ Already Completed

1. ‚úÖ Added authService mock (lines 35-47)
2. ‚úÖ Added authService import (line 19)
3. ‚úÖ Added helper functions `setupAuthenticatedMocks` and `setupUnauthenticatedMocks` (lines 142-160)
4. ‚úÖ Updated beforeEach with default authService mocks (lines 163-171)
5. ‚úÖ Updated "Login Flow" tests to use `setupUnauthenticatedMocks()` (lines 173-234)

---

## üîß Tasks To Complete

### **Task 1: Fix "Protected Routes" - First test (Line ~239)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(fetchAuthSession as jest.Mock).mockRejectedValue(
  new Error("Not authenticated"),
);
(authService.isAuthenticated as jest.Mock).mockResolvedValue(false);
```

**Change to:**

```typescript
setupUnauthenticatedMocks();

Run a test
Update github

- [x] Status:
```

---

### **Task 2: Fix "Protected Routes" - Second test (Line ~257)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAdminUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockAdminToken),
);
(authService.isAuthenticated as jest.Mock).mockResolvedValue(true);
(authService.getCurrentUserEmail as jest.Mock).mockResolvedValue(
  "admin@test.com",
);
(authService.getCurrentUserName as jest.Mock).mockResolvedValue("Admin User");
(authService.getCurrentUserRoles as jest.Mock).mockResolvedValue([
  "Administrators",
]);
(authService.getCurrentUserTenants as jest.Mock).mockResolvedValue(["tenant1"]);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAdminUser, mockAdminToken, ["Administrators"]);
```

Run a test

Clear warnings
Run a test

Update github

- [x] Status:

---

### **Task 3: Fix "Protected Routes" - Third test (Line ~281)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAdminUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockAdminToken),
);
(signOut as jest.Mock).mockResolvedValue(undefined);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAdminUser, mockAdminToken, ["Administrators"]);
(signOut as jest.Mock).mockResolvedValue(undefined);
```

Run a test

Clear warnings
Run a test

Update github

- [x] Status:

---

### **Task 4: Fix "Role-Based Access Control" - Admin test (Line ~318)**

**Status:** ‚úÖ VERIFIED (7.885s, cosmetic worker warning only)  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAdminUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockAdminToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAdminUser, mockAdminToken, ["Administrators"]);
```

Run a test
Clear warnings
Run a test
Update github

- [x] Status:

---

### **Task 5: Fix "Role-Based Access Control" - Accountant test (Line ~335)**

**Status:** ‚úÖ VERIFIED (25.016s, cosmetic worker warning only)  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAccountantUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockAccountantToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAccountantUser, mockAccountantToken, [
  "Accountants",
]);
```

Run a test

Clear warnings
Run a test

Update github

- [x] Status:

---

### **Task 6: Fix "Role-Based Access Control" - Viewer test (Line ~352)**

**Status:** ‚úÖ VERIFIED (26.08s, cosmetic worker warning only)  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockViewerUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockViewerToken),
);
```

---

**Change to:**

```typescript
setupAuthenticatedMocks(mockViewerUser, mockViewerToken, ["Viewers"]);
```

Run a test

Clear warnings
Run a test

Update github


### **Task 7: Fix "Role-Based Access Control" - Block viewer test (Line ~369)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockViewerUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockViewerToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockViewerUser, mockViewerToken, ["Viewers"]);
```

Run a test

Clear warnings
Run a test

Update github

- [ ] Status:

---

### **Task 8: Fix "Role-Based Access Control" - Unauthorized page test (Line ~387)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockViewerUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockViewerToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockViewerUser, mockViewerToken, ["Viewers"]);
```

Run a test

Clear warnings
Run a test

Update github

- [ ] Status:

---

### **Task 9: Fix "Role-Based Access Control" - Any role test (Line ~406)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAccountantUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockAccountantToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAccountantUser, mockAccountantToken, [
  "Accountants",
]);
```

Run a test

Clear warnings
Run a test

Update github

- [ ] Status:

---

### **Task 10: Fix "Logout Functionality" test (Line ~425)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAdminUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockAdminToken),
);
(signOut as jest.Mock).mockResolvedValue(undefined);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAdminUser, mockAdminToken, ["Administrators"]);
(signOut as jest.Mock).mockResolvedValue(undefined);
```

Run a test

Clear warnings
Run a test

Update github

- [ ] Status:

---

### **Task 11: Fix "Token Expiration" - Expired token test (Line ~445)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAdminUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(expiredToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAdminUser, expiredToken, ["Administrators"]);
```

---

### **Task 12: Fix "Token Expiration" - Valid token test (Line ~470)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockAdminUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(validToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockAdminUser, validToken, ["Administrators"]);
```

---

### **Task 13: Fix "User Experience" - Loading state test (Line ~499)** ‚ö†Ô∏è CRITICAL

**Status:** ‚è≥ Pending  
**Priority:** HIGH - This test causes the hang!  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockImplementation(() => new Promise(() => {})); // Never resolves
(fetchAuthSession as jest.Mock).mockImplementation(() => new Promise(() => {}));
```

**Change to:**

```typescript
// Skip this test or use delayed promises instead of never-resolving
it.skip("should show loading state while checking authentication", async () => {
  // This test is skipped because testing loading states with never-resolving promises
  // causes the test suite to hang. Consider using a different approach.
});
```

**Alternative fix:**

```typescript
(getCurrentUser as jest.Mock).mockImplementation(
  () => new Promise((resolve) => setTimeout(resolve, 100)),
);
(fetchAuthSession as jest.Mock).mockImplementation(
  () => new Promise((resolve) => setTimeout(resolve, 100)),
);
setupUnauthenticatedMocks();
```

---

### **Task 14: Fix "User Experience" - Display email test (Line ~516)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockViewerUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockViewerToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockViewerUser, mockViewerToken, ["Viewers"]);
```

---

### **Task 15: Fix "User Experience" - Forgot password test (Line ~527)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(fetchAuthSession as jest.Mock).mockRejectedValue(
  new Error("Not authenticated"),
);
```

**Change to:**

```typescript
setupUnauthenticatedMocks();
```

---

### **Task 16: Fix "User Experience" - Go back button test (Line ~537)**

**Status:** ‚è≥ Pending  
**Current code:**

```typescript
(getCurrentUser as jest.Mock).mockResolvedValue(mockViewerUser);
(fetchAuthSession as jest.Mock).mockResolvedValue(
  createMockSession(mockViewerToken),
);
```

**Change to:**

```typescript
setupAuthenticatedMocks(mockViewerUser, mockViewerToken, ["Viewers"]);
```

---

## Testing Strategy

After each task:

1. Save the file
2. Run the specific test to verify it works:
   ```bash
   cd frontend
   npm test -- authentication.integration.test.tsx --testNamePattern="test name"
   ```
3. Mark the task as complete
4. Move to the next task

After all tasks:

1. Run all authentication tests:
   ```bash
   npm test -- authentication.integration.test.tsx
   ```
2. Run the full build:
   ```bash
   cd ..
   .\scripts\CICD\build.ps1
   ```

---

## Progress Tracking

- Total Tasks: 16
- Completed: 0
- Remaining: 16
- Critical Tasks: 1 (Task 13)

**Recommended Order:**

1. Task 13 (CRITICAL - fixes the hang)
2. Tasks 1-3 (Protected Routes - where hang occurs)
3. Tasks 4-9 (Role-Based Access Control)
4. Tasks 10-12 (Logout and Token Expiration)
5. Tasks 14-16 (User Experience)

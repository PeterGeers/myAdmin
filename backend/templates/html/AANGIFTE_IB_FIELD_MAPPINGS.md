# Aangifte IB (Income Tax) Template Field Mappings

This document describes the field mappings for Aangifte IB (Inkomstenbelasting) HTML report templates.

## Template Files

- **Dutch (NL)**: `aangifte_ib_template.html`

## Template Type

- **Template Type ID**: `aangifte_ib_html`
- **Category**: HTML Reports (Customizable per tenant)
- **Output Format**: HTML
- **Storage**: Tenant-specific Google Drive folder

## Field Mappings

### Report Metadata Fields

These fields contain basic information about the report.

| Field Name       | Type    | Description                      | Example            |
| ---------------- | ------- | -------------------------------- | ------------------ |
| `year`           | integer | Report year                      | 2025               |
| `administration` | string  | Administration/tenant identifier | "GoodwinSolutions" |
| `generated_date` | string  | Report generation timestamp      | "2026-01-31 14:30" |

### Dynamic Content Fields

| Field Name   | Type | Description                         | Generated By                                  |
| ------------ | ---- | ----------------------------------- | --------------------------------------------- |
| `table_rows` | HTML | Hierarchical table rows (see below) | `aangifte_ib_generator.generate_table_rows()` |

## Table Rows Structure

The `table_rows` field contains a hierarchical structure with five row types:

### 1. Parent Row

Top-level category rows (e.g., 1000, 2000, 3000, 4000).

**Structure:**

```python
{
    'row_type': 'parent',
    'parent': '1000',              # Parent code
    'aangifte': '',
    'description': '',
    'amount': '88,130.07',         # Formatted amount
    'amount_raw': 88130.07,        # Raw numeric value
    'css_class': 'parent-row',
    'indent_level': 0
}
```

**HTML Output:**

```html
<tr class="parent-row">
  <td>1000</td>
  <td></td>
  <td></td>
  <td class="amount">88,130.07</td>
</tr>
```

**Styling:**

- Background: Gray (#f0f0f0)
- Font weight: Bold
- No indentation

### 2. Aangifte Row

Sub-category rows within each parent (e.g., "Liquide middelen", "BTW").

**Structure:**

```python
{
    'row_type': 'aangifte',
    'parent': '',
    'aangifte': 'Liquide middelen',  # Aangifte name
    'description': '',
    'amount': '88,262.80',
    'amount_raw': 88262.80,
    'css_class': 'aangifte-row',
    'indent_level': 1
}
```

**HTML Output:**

```html
<tr class="aangifte-row">
  <td class="indent-1"></td>
  <td>Liquide middelen</td>
  <td></td>
  <td class="amount">88,262.80</td>
</tr>
```

**Styling:**

- Background: Light gray (#f8f8f8)
- Font weight: Semi-bold
- Indentation: 1 level (20px)

### 3. Account Row

Individual account detail rows (e.g., bank accounts, expense accounts).

**Structure:**

```python
{
    'row_type': 'account',
    'parent': '',
    'aangifte': '1002',                      # Account number
    'description': 'NL80RABO0107936917 RCRT', # Account description
    'amount': '45,678.90',
    'amount_raw': 45678.90,
    'css_class': 'account-row',
    'indent_level': 2
}
```

**HTML Output:**

```html
<tr class="account-row">
  <td class="indent-2"></td>
  <td>1002</td>
  <td>NL80RABO0107936917 RCRT</td>
  <td class="amount">45,678.90</td>
</tr>
```

**Styling:**

- Background: White
- Font weight: Normal
- Indentation: 2 levels (40px)

### 4. Resultaat Row

Summary row showing profit/loss (only P&L accounts: 4000+).

**Structure:**

```python
{
    'row_type': 'resultaat',
    'parent': 'RESULTAAT',
    'aangifte': '',
    'description': '',
    'amount': '28,853.76',
    'amount_raw': 28853.76,
    'css_class': 'resultaat-positive',  # or 'resultaat-negative'
    'indent_level': 0
}
```

**HTML Output:**

```html
<tr class="resultaat-positive">
  <td>RESULTAAT</td>
  <td></td>
  <td></td>
  <td class="amount">28,853.76</td>
</tr>
```

**Styling:**

- Background: Green (#d4edda) if positive, Red (#f8d7da) if negative
- Font weight: Bold
- No indentation

**Calculation Logic:**

```python
# RESULTAAT = Sum of P&L accounts only (Parents 4000+)
# Balance sheet accounts (1000-3000) are excluded
resultaat = sum(
    amount for item in report_data
    if item['Parent'].startswith(('4', '5', '6', '7', '8', '9'))
)
```

### 5. Grand Total Row

Final summary row (should be close to zero for balanced accounts).

**Structure:**

```python
{
    'row_type': 'grand_total',
    'parent': 'GRAND TOTAL',
    'aangifte': '',
    'description': '',
    'amount': '-0.00',
    'amount_raw': 0.0,
    'css_class': 'grand-total',
    'indent_level': 0
}
```

**HTML Output:**

```html
<tr class="grand-total">
  <td>GRAND TOTAL</td>
  <td></td>
  <td></td>
  <td class="amount">-0.00</td>
</tr>
```

**Styling:**

- Background: Orange (#ffc107)
- Font weight: Bold
- No indentation

## Hierarchical Structure

The report follows a three-level hierarchy:

```
Parent (1000)
├── Aangifte (Liquide middelen)
│   ├── Account (1002 - NL80RABO0107936917 RCRT)
│   ├── Account (1003 - NL80RABO0107936918 SPAAR)
│   └── Account (1004 - Revolut)
├── Aangifte (Debiteuren)
│   └── Account (1300 - Debiteuren)
└── ...

Parent (4000)
├── Aangifte (Omzet)
│   ├── Account (8001 - Omzet diensten)
│   └── Account (8002 - Omzet producten)
└── ...

RESULTAAT (calculated from 4000+ accounts)
GRAND TOTAL (should be ~0)
```

## Data Source

All data is sourced from the cache (mutaties_cache) with the following queries:

### Summary Data Query

```python
# Get parent and aangifte totals
summary_data = cache.query_aangifte_ib(
    year=year,
    administration=administration
)
# Returns: [{'Parent': '1000', 'Aangifte': 'Liquide middelen', 'Amount': 88262.80}, ...]
```

### Account Details Query

```python
# Get individual account details for each parent-aangifte combination
details = cache.query_aangifte_ib_details(
    year=year,
    administration=administration,
    parent='1000',
    aangifte='Liquide middelen',
    user_tenants=['GoodwinSolutions', 'PeterPrive']  # Security filtering
)
# Returns: [{'Reknum': '1002', 'AccountName': 'NL80RABO0107936917 RCRT', 'Amount': 45678.90}, ...]
```

## Formatting Rules

### Currency Formatting

- **Format**: `€ X.XXX,XX` (Dutch format with period as thousands separator, comma as decimal separator)
- **No currency symbol**: Unlike other reports, Aangifte IB uses plain numbers
- **Decimal places**: Always 2
- **Function**: `format_amount()` from `common_formatters`
- **Example**: `1.234,56` (one thousand two hundred thirty-four euros and fifty-six cents)

### HTML Escaping

All text fields are HTML-escaped to prevent XSS attacks:

- Parent codes
- Aangifte names
- Account numbers
- Account descriptions

### Zero Amount Filtering

Rows with amounts less than €0.01 are automatically filtered out:

```python
if abs(amount) < 0.01:
    continue  # Skip this row
```

## Security Features

### Tenant Isolation

The `user_tenants` parameter ensures users can only see data for tenants they have access to:

```python
# SECURITY: Pass user_tenants to filter cached data
details = cache.query_aangifte_ib_details(
    year=year,
    administration=administration,
    parent=parent,
    aangifte=aangifte,
    user_tenants=user_tenants  # Only accessible tenants
)
```

## Customization Per Tenant

Tenants can customize the following aspects:

1. **Company Information** - Add company header/footer
2. **Logo** - Add company logo to template
3. **Styling** - Modify CSS to match tenant branding
4. **Additional Fields** - Add custom fields or notes
5. **Language** - Currently Dutch only, but can be extended
6. **Row Filtering** - Customize which accounts to show/hide

## Template Storage

- **Development**: `backend/templates/html/aangifte_ib_template.html`
- **Production**: Tenant-specific Google Drive folder
  - Path: `templates_{tenant}/aangifte_ib_template.html`
  - Metadata stored in: `tenant_template_config` table

## Database Schema

```sql
CREATE TABLE tenant_template_config (
    id INT AUTO_INCREMENT PRIMARY KEY,
    administration VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,  -- 'aangifte_ib_html'
    template_file_id VARCHAR(255) NOT NULL,  -- Google Drive file ID
    field_mappings JSON,  -- Field mapping configuration
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_tenant_template (administration, template_type)
);
```

## Example Field Mappings JSON

```json
{
  "fields": {
    "year": {
      "path": "year",
      "format": "number"
    },
    "administration": {
      "path": "administration",
      "format": "text"
    },
    "generated_date": {
      "path": "generated_date",
      "format": "datetime"
    },
    "table_rows": {
      "path": "table_rows",
      "format": "html",
      "pre_generated": true
    }
  },
  "formatting": {
    "locale": "nl_NL",
    "currency": "EUR",
    "number_decimals": 2,
    "thousands_separator": ".",
    "decimal_separator": ","
  },
  "hierarchy": {
    "levels": ["parent", "aangifte", "account"],
    "indent_pixels": 20
  }
}
```

## Usage Example

```python
from report_generators import aangifte_ib_generator
from services.template_service import TemplateService

# Step 1: Get summary data from cache
summary_data = cache.query_aangifte_ib(
    year=2025,
    administration='GoodwinSolutions'
)

# Step 2: Generate table rows
table_rows = aangifte_ib_generator.generate_table_rows(
    report_data=summary_data,
    cache=cache,
    year=2025,
    administration='GoodwinSolutions',
    user_tenants=['GoodwinSolutions', 'PeterPrive']
)

# Step 3: Prepare template data
template_data = {
    'year': 2025,
    'administration': 'GoodwinSolutions',
    'generated_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
    'table_rows': table_rows
}

# Step 4: Load template
with open('backend/templates/html/aangifte_ib_template.html', 'r') as f:
    template = f.read()

# Step 5: Apply template
template_service = TemplateService()
html = template_service.apply_template(
    template_content=template,
    data=template_data
)

# Step 6: Save or return HTML
with open('Aangifte_IB_2025.html', 'w') as f:
    f.write(html)
```

## Related Files

- **Generator**: `backend/src/report_generators/aangifte_ib_generator.py`
- **Routes**: `backend/src/app.py` (aangifte_ib_export route)
- **Template**: `backend/templates/html/aangifte_ib_template.html`
- **Common Formatters**: `backend/src/report_generators/common_formatters.py`
- **Template Service**: `backend/src/services/template_service.py`
- **Usage Guide**: `backend/templates/html/AANGIFTE_IB_TEMPLATE_USAGE.md`

## Migration Notes

This template-based approach replaces the hardcoded HTML generation in `app.py`. The key improvements are:

1. **Separation of Concerns**: Data processing (generator) vs. presentation (template)
2. **Customizability**: Tenants can customize templates without code changes
3. **Maintainability**: Template changes don't require code deployment
4. **Consistency**: Uses common formatters and patterns across all reports
5. **Testability**: Generator logic can be unit tested independently
6. **Security**: Proper tenant isolation with user_tenants filtering

## Testing

To test the Aangifte IB report generation:

```python
# Test with sample data
from report_generators import aangifte_ib_generator
from mutaties_cache import get_cache

cache = get_cache()
cache.get_data(db)

summary_data = cache.query_aangifte_ib(
    year=2025,
    administration='GoodwinSolutions'
)

rows = aangifte_ib_generator.generate_table_rows(
    report_data=summary_data,
    cache=cache,
    year=2025,
    administration='GoodwinSolutions',
    user_tenants=['GoodwinSolutions']
)

assert len(rows) > 0
assert any(row['row_type'] == 'parent' for row in rows)
assert any(row['row_type'] == 'aangifte' for row in rows)
assert any(row['row_type'] == 'account' for row in rows)
assert any(row['row_type'] == 'resultaat' for row in rows)
assert any(row['row_type'] == 'grand_total' for row in rows)
```

## Notes

- Aangifte IB reports are **tenant-specific** and customizable per tenant
- Template supports Dutch language only (can be extended for other languages)
- All amounts are formatted with comma as thousands separator and period as decimal separator
- The report includes both balance sheet (1000-3000) and P&L accounts (4000+)
- RESULTAAT is calculated only from P&L accounts (4000+)
- GRAND TOTAL should be close to zero for balanced accounts
- Zero amounts (< €0.01) are automatically filtered out
- Security filtering ensures users only see data for their accessible tenants

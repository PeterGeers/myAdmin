# STR Invoice Template Field Mappings

This document describes the field mappings for STR (Short-Term Rental) invoice templates.

## Template Files

- **Dutch (NL)**: `str_invoice_nl_template.html`
- **English (UK)**: `str_invoice_en_template.html`

## Template Type

- **Template Type ID**: `str_invoice_nl` or `str_invoice_en`
- **Category**: HTML Reports (Customizable per tenant)
- **Output Format**: HTML
- **Storage**: Tenant-specific Google Drive folder

## Field Mappings

### Company Information Fields

These fields contain the company/tenant information that appears in the invoice header.

| Field Name            | Type   | Description                 | Example                              |
| --------------------- | ------ | --------------------------- | ------------------------------------ |
| `company_name`        | string | Company legal name          | "Jabaki a Goodwin Solutions Company" |
| `company_address`     | string | Street address              | "Beemsterstraat 3"                   |
| `company_postal_city` | string | Postal code and city        | "2131 ZA Hoofddorp"                  |
| `company_country`     | string | Country name                | "Nederland" / "Netherlands"          |
| `company_vat`         | string | VAT/Tax ID number           | "NL812613764B02"                     |
| `company_coc`         | string | Chamber of Commerce number  | "24352408"                           |
| `contact_email`       | string | Contact email for inquiries | "peter@jabaki.nl"                    |

### Booking Information Fields

These fields contain details about the reservation and guest.

| Field Name        | Type    | Description                   | Example                 |
| ----------------- | ------- | ----------------------------- | ----------------------- |
| `reservationCode` | string  | Unique reservation identifier | "ABC123456"             |
| `guestName`       | string  | Guest full name               | "John Doe"              |
| `channel`         | string  | Booking channel/platform      | "Airbnb", "Booking.com" |
| `listing`         | string  | Property name                 | "Beach House Amsterdam" |
| `checkinDate`     | date    | Check-in date (DD-MM-YYYY)    | "15-06-2025"            |
| `checkoutDate`    | date    | Check-out date (DD-MM-YYYY)   | "20-06-2025"            |
| `nights`          | integer | Number of nights              | 5                       |
| `guests`          | integer | Number of guests              | 2                       |

### Billing Information Fields

These fields contain billing address information (can be customized per invoice).

| Field Name        | Type   | Description            | Example                  |
| ----------------- | ------ | ---------------------- | ------------------------ |
| `billing_name`    | string | Bill-to name           | "John Doe"               |
| `billing_address` | string | Bill-to address line 1 | "Via Airbnb"             |
| `billing_city`    | string | Bill-to address line 2 | "Reservering: ABC123456" |

### Financial Fields

These fields contain the financial breakdown of the invoice.

| Field Name         | Type    | Description                                | Example |
| ------------------ | ------- | ------------------------------------------ | ------- |
| `net_amount`       | decimal | Net accommodation charge (excl. VAT & tax) | 500.00  |
| `vat_amount`       | decimal | VAT amount                                 | 105.00  |
| `tourist_tax`      | decimal | Tourist tax amount                         | 15.00   |
| `amountGross`      | decimal | Total gross amount                         | 620.00  |
| `amountChannelFee` | decimal | Channel commission (not shown on invoice)  | 62.00   |
| `amountNett`       | decimal | Net amount after channel fee               | 558.00  |

### Date Fields

| Field Name     | Type | Description                     | Example      |
| -------------- | ---- | ------------------------------- | ------------ |
| `invoice_date` | date | Invoice issue date (DD-MM-YYYY) | "15-06-2025" |
| `due_date`     | date | Payment due date (DD-MM-YYYY)   | "15-06-2025" |

### Dynamic Content

| Field Name   | Type | Description                   | Generated By                                  |
| ------------ | ---- | ----------------------------- | --------------------------------------------- |
| `table_rows` | HTML | Invoice line items table rows | `str_invoice_generator.generate_table_rows()` |

## Table Rows Structure

The `table_rows` field is dynamically generated and contains HTML table rows with the following structure:

```html
<tr>
  <td>Description</td>
  <td>Quantity</td>
  <td>Price</td>
  <td>Amount</td>
</tr>
```

### Line Items Included

1. **Accommodation/Stay** - Net amount for the property rental
2. **VAT** (conditional) - Only shown if `vat_amount > 0`
3. **Tourist Tax** (conditional) - Only shown if `tourist_tax > 0`
4. **Total** - Total gross amount (always shown)

## Language Support

### Dutch (NL) Labels

- Stay: "Verblijf {listing}"
- VAT: "BTW"
- Tourist Tax: "Toeristenbelasting"
- Total: "Totaal"

### English (EN) Labels

- Stay: "Stay at {listing}"
- VAT: "VAT"
- Tourist Tax: "Tourist Tax"
- Total: "Total"

## Conditional Logic

### VAT Display

- **Condition**: `vat_amount > 0`
- **Action**: Show VAT line item in table
- **Default**: Hide VAT line item if amount is 0

### Tourist Tax Display

- **Condition**: `tourist_tax > 0`
- **Action**: Show tourist tax line item in table
- **Default**: Hide tourist tax line item if amount is 0

## Data Source

All invoice data is sourced from the `vw_bnb_total` database view with the following query:

```sql
SELECT amountGross, checkinDate, checkoutDate, guestName, channel,
       listing, nights, guests, reservationCode, amountTouristTax,
       amountChannelFee, amountNett, amountVat, administration
FROM vw_bnb_total
WHERE reservationCode = ? AND administration IN (?)
```

## Customization Per Tenant

Tenants can customize the following aspects:

1. **Company Information** - All company fields can be configured per tenant
2. **Logo** - Logo image can be replaced (currently hardcoded as `/jabaki-logo.png`)
3. **Contact Email** - Support email can be customized
4. **Styling** - CSS can be modified to match tenant branding
5. **Language** - Choose between Dutch (NL) or English (EN) templates

## Template Storage

- **Development**: `backend/templates/html/str_invoice_{language}_template.html`
- **Production**: Tenant-specific Google Drive folder
  - Path: `templates_{tenant}/str_invoice_{language}_template.html`
  - Metadata stored in: `tenant_template_config` table

## Database Schema

```sql
CREATE TABLE tenant_template_config (
    id INT AUTO_INCREMENT PRIMARY KEY,
    administration VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,  -- 'str_invoice_nl' or 'str_invoice_en'
    template_file_id VARCHAR(255) NOT NULL,  -- Google Drive file ID
    field_mappings JSON,  -- Field mapping configuration
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_tenant_template (administration, template_type)
);
```

## Example Field Mappings JSON

```json
{
  "fields": {
    "company_name": {
      "path": "company_name",
      "format": "text",
      "default": "Jabaki a Goodwin Solutions Company"
    },
    "company_address": {
      "path": "company_address",
      "format": "text",
      "default": "Beemsterstraat 3"
    },
    "net_amount": {
      "path": "net_amount",
      "format": "currency",
      "transform": "round"
    },
    "invoice_date": {
      "path": "invoice_date",
      "format": "date"
    }
  },
  "formatting": {
    "locale": "nl_NL",
    "currency": "EUR",
    "date_format": "DD-MM-YYYY",
    "number_decimals": 2
  },
  "conditionals": [
    {
      "field": "vat_amount",
      "operator": "gt",
      "value": 0,
      "action": "show"
    },
    {
      "field": "tourist_tax",
      "operator": "gt",
      "value": 0,
      "action": "show"
    }
  ]
}
```

## Usage Example

```python
from report_generators import str_invoice_generator

# Prepare invoice data from booking
invoice_data = str_invoice_generator.prepare_invoice_data(
    booking_data,
    custom_billing={'name': 'Custom Name', 'address': 'Custom Address'}
)

# Generate table rows
table_rows = str_invoice_generator.generate_table_rows(invoice_data, language='nl')

# Load template and replace placeholders
with open('str_invoice_nl_template.html', 'r') as f:
    template = f.read()

html = template.replace('{{ table_rows }}', table_rows)
for key, value in invoice_data.items():
    html = html.replace(f'{{{{ {key} }}}}', str(value))
```

## Related Files

- Generator: `backend/src/report_generators/str_invoice_generator.py`
- Routes: `backend/src/str_invoice_routes.py`
- Templates: `backend/templates/html/str_invoice_{nl|en}_template.html`
- Tests: `backend/tests/integration/test_str_invoice_generation.py`

## Notes

- STR invoices are **tenant-specific** and customizable per tenant
- Templates support both Dutch (NL) and English (EN) languages
- All currency values are formatted with 2 decimal places
- Dates are formatted as DD-MM-YYYY
- The invoice is marked as "already paid" via the booking channel

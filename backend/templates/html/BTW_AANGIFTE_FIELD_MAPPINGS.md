# BTW Aangifte Template Field Mappings

This document describes the field mappings for BTW Aangifte (VAT Declaration) templates.

## Template Files

- **Dutch (NL)**: `btw_aangifte_template.html`

## Template Type

- **Template Type ID**: `btw_aangifte_html`
- **Category**: HTML Reports (Customizable per tenant)
- **Output Format**: HTML
- **Storage**: Tenant-specific Google Drive folder

## Field Mappings

### Report Metadata Fields

These fields contain basic information about the report.

| Field Name       | Type    | Description                      | Example            |
| ---------------- | ------- | -------------------------------- | ------------------ |
| `administration` | string  | Administration/tenant identifier | "GoodwinSolutions" |
| `year`           | integer | Report year                      | 2025               |
| `quarter`        | integer | Quarter number (1-4)             | 1                  |
| `end_date`       | date    | Quarter end date (YYYY-MM-DD)    | "2025-03-31"       |
| `generated_date` | string  | Report generation timestamp      | "2025-01-31 14:30" |

### Balance Data Fields

Balance data shows BTW account balances up to the quarter end date.

| Field Name     | Type | Description                 | Generated By                                  |
| -------------- | ---- | --------------------------- | --------------------------------------------- |
| `balance_rows` | HTML | Table rows for balance data | `btw_aangifte_generator._format_table_rows()` |

**Balance Accounts Included**:

- 2010: BTW te betalen/ontvangen
- 2020: BTW ontvangen
- 2021: BTW vooruitbetaald

### Quarter Data Fields

Quarter data shows BTW and revenue accounts for the specific quarter.

| Field Name     | Type | Description                 | Generated By                                  |
| -------------- | ---- | --------------------------- | --------------------------------------------- |
| `quarter_rows` | HTML | Table rows for quarter data | `btw_aangifte_generator._format_table_rows()` |

**Quarter Accounts Included**:

- 2010: BTW te betalen/ontvangen
- 2020: BTW ontvangen
- 2021: BTW vooruitbetaald
- 8001: Revenue account 1
- 8002: Revenue account 2
- 8003: Revenue account 3

### Calculation Fields

These fields contain calculated VAT amounts and payment instructions.

| Field Name            | Type   | Description                                | Example             |
| --------------------- | ------ | ------------------------------------------ | ------------------- |
| `payment_instruction` | string | Payment instruction (te betalen/ontvangen) | "€1,234 te betalen" |
| `received_btw`        | string | Total received BTW (formatted)             | "€ 5,678.00"        |
| `prepaid_btw`         | string | Prepaid BTW amount (formatted)             | "€ 4,444.00"        |

### Calculation Logic

The BTW calculations follow this logic:

1. **Total Balance** = Sum of all balance data (accounts 2010, 2020, 2021)
2. **Received BTW** = Sum of accounts 2020, 2021 from quarter data
3. **Prepaid BTW** = Received BTW - Total Balance
4. **Payment Instruction**:
   - If Total Balance >= 0: "€X te ontvangen" (to receive)
   - If Total Balance < 0: "€X te betalen" (to pay)

## Table Rows Structure

Both `balance_rows` and `quarter_rows` fields contain HTML table rows with the following structure:

```html
<tr>
  <td>Reknum</td>
  <td>AccountName</td>
  <td class="amount">€ X.XXX,XX</td>
</tr>
```

### Row Data

Each row contains:

- **Reknum**: Account number (e.g., "2010", "2020", "8001")
- **AccountName**: Account description (e.g., "BTW te betalen", "BTW ontvangen")
- **Amount**: Formatted currency amount with € symbol

## Data Source

All BTW data is sourced from the cache (mutaties_cache) with the following filters:

### Balance Data Query

```python
# Filter by date
df_filtered = df[df['TransactionDate'] <= end_date]

# Filter by administration
df_filtered = df_filtered[df_filtered['administration'].str.startswith(administration)]

# Filter by BTW accounts
df_filtered = df_filtered[df_filtered['Reknum'].isin(['2010', '2020', '2021'])]

# Group by account
grouped = df_filtered.groupby(['Reknum', 'AccountName']).agg({'Amount': 'sum'})
```

### Quarter Data Query

```python
# Filter by year and quarter
df_filtered = df[(df['jaar'] == year) & (df['kwartaal'] == quarter)]

# Filter by administration
df_filtered = df_filtered[df_filtered['administration'].str.startswith(administration)]

# Filter by BTW and revenue accounts
df_filtered = df_filtered[df_filtered['Reknum'].isin(['2010', '2020', '2021', '8001', '8002', '8003'])]

# Group by account
grouped = df_filtered.groupby(['Reknum', 'AccountName']).agg({'Amount': 'sum'})
```

## Customization Per Tenant

Tenants can customize the following aspects:

1. **Company Information** - Add company header/footer if needed
2. **Logo** - Add company logo to template
3. **Styling** - Modify CSS to match tenant branding
4. **Additional Fields** - Add custom fields or notes
5. **Language** - Currently Dutch only, but can be extended

## Template Storage

- **Development**: `backend/templates/html/btw_aangifte_template.html`
- **Production**: Tenant-specific Google Drive folder
  - Path: `templates_{tenant}/btw_aangifte_template.html`
  - Metadata stored in: `tenant_template_config` table

## Database Schema

```sql
CREATE TABLE tenant_template_config (
    id INT AUTO_INCREMENT PRIMARY KEY,
    administration VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,  -- 'btw_aangifte_html'
    template_file_id VARCHAR(255) NOT NULL,  -- Google Drive file ID
    field_mappings JSON,  -- Field mapping configuration
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_tenant_template (administration, template_type)
);
```

## Example Field Mappings JSON

```json
{
  "fields": {
    "administration": {
      "path": "administration",
      "format": "text"
    },
    "year": {
      "path": "year",
      "format": "number"
    },
    "quarter": {
      "path": "quarter",
      "format": "number"
    },
    "end_date": {
      "path": "end_date",
      "format": "date"
    },
    "payment_instruction": {
      "path": "payment_instruction",
      "format": "text"
    },
    "received_btw": {
      "path": "received_btw",
      "format": "currency"
    },
    "prepaid_btw": {
      "path": "prepaid_btw",
      "format": "currency"
    }
  },
  "formatting": {
    "locale": "nl_NL",
    "currency": "EUR",
    "date_format": "YYYY-MM-DD",
    "number_decimals": 2
  }
}
```

## Usage Example

```python
from report_generators import btw_aangifte_generator

# Generate report data
report_data = btw_aangifte_generator.generate_btw_report(
    cache=cache,
    db=db,
    administration='GoodwinSolutions',
    year=2025,
    quarter=1
)

# Prepare template data
template_data = btw_aangifte_generator.prepare_template_data(report_data)

# Load template
with open('btw_aangifte_template.html', 'r') as f:
    template = f.read()

# Replace placeholders
html = template
for key, value in template_data.items():
    html = html.replace(f'{{{{ {key} }}}}', str(value))

# Save or return HTML
with open('BTW_Aangifte_2025_Q1.html', 'w') as f:
    f.write(html)
```

## Related Files

- Generator: `backend/src/report_generators/btw_aangifte_generator.py`
- Routes: `backend/src/app.py` (BTW routes section)
- Template: `backend/templates/html/btw_aangifte_template.html`
- Legacy Processor: `backend/src/btw_processor.py` (for reference)

## Migration Notes

This template-based approach replaces the hardcoded HTML generation in `btw_processor.py`. The key improvements are:

1. **Separation of Concerns**: Data processing (generator) vs. presentation (template)
2. **Customizability**: Tenants can customize templates without code changes
3. **Maintainability**: Template changes don't require code deployment
4. **Consistency**: Uses common formatters and patterns across all reports
5. **Testability**: Generator logic can be unit tested independently

## Testing

To test the BTW Aangifte report generation:

```python
# Test with sample data
from report_generators import btw_aangifte_generator
from mutaties_cache import get_cache
from database import DatabaseManager

cache = get_cache()
db = DatabaseManager(test_mode=True)
cache.get_data(db)

report = btw_aangifte_generator.generate_btw_report(
    cache=cache,
    db=db,
    administration='GoodwinSolutions',
    year=2025,
    quarter=1
)

assert report['success'] == True
assert 'balance_rows' in report
assert 'quarter_rows' in report
assert 'calculations' in report
```

## Notes

- BTW Aangifte reports are **tenant-specific** and customizable per tenant
- Template supports Dutch language only (can be extended for other languages)
- All currency values are formatted with € symbol and 2 decimal places
- Dates are formatted as YYYY-MM-DD
- The report includes a link to Belastingdienst login portal
- Calculations follow Dutch VAT declaration rules

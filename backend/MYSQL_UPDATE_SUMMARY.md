# MySQL Database Update Summary - STR Invoice Field Mappings

## Date: January 31, 2026

## Overview

Successfully updated all STR invoice field mappings in the `tenant_template_config` table to match the TemplateService requirements.

## Changes Made

### Before (Incorrect Structure)

```json
{
  "fields": {
    "guestName": {
      "path": "guestName",
      "type": "string",              // ❌ Wrong property
      "description": "Guest name"    // ❌ Not used
    }
  },
  "conditionals": [
    {
      "action": "show_vat_line"      // ❌ Wrong action name
    }
  ],
  "version": "1.0",                  // ❌ Extra metadata
  "languages": ["nl", "en"],         // ❌ Extra metadata
  "data_source": {...},              // ❌ Extra metadata
  "output_format": "html",           // ❌ Extra metadata
  "template_location": {...},        // ❌ Extra metadata
  "output_storage": {...}            // ❌ Extra metadata
}
```

### After (Correct Structure)

```json
{
  "fields": {
    "guestName": {
      "source": "database", // ✅ Required property
      "path": "guestName",
      "format": "text",
      "default": ""
    },
    "net_amount": {
      "source": "database",
      "path": "net_amount",
      "format": "currency",
      "transform": "round", // ✅ Added for currency fields
      "default": 0
    },
    "company_name": {
      "source": "static", // ✅ Static tenant data
      "path": "company_name",
      "format": "text",
      "default": "Jabaki a Goodwin Solutions Company"
    },
    "table_rows": {
      "source": "calculation", // ✅ Pre-generated by generator
      "path": "table_rows",
      "format": "text",
      "default": ""
    }
  },
  "conditionals": [
    {
      "field": "vat_amount",
      "operator": "gt",
      "value": 0,
      "action": "show" // ✅ Standard action name
    }
  ],
  "formatting": {
    "locale": "nl_NL",
    "currency": "EUR",
    "date_format": "DD-MM-YYYY",
    "number_decimals": 2
  }
}
```

## Records Updated

| ID  | Administration   | Template Type  | Status     |
| --- | ---------------- | -------------- | ---------- |
| 4   | GoodwinSolutions | str_invoice_nl | ✅ Updated |
| 5   | GoodwinSolutions | str_invoice_en | ✅ Updated |
| 10  | PeterPrive       | str_invoice_nl | ✅ Updated |
| 11  | PeterPrive       | str_invoice_en | ✅ Updated |

## Key Changes

### 1. Added `source` Property

All fields now have a `source` property indicating data origin:

- `database` - Data from booking query
- `static` - Tenant-specific static data (company info)
- `calculation` - Pre-generated by report_generators (table_rows)

### 2. Removed Unused Properties

- Removed `type` (replaced with `source`)
- Removed `description` (not used by TemplateService)
- Removed top-level metadata (`version`, `languages`, `data_source`, etc.)

### 3. Added `transform` for Currency Fields

Currency fields now have `transform: "round"` for proper formatting:

- `net_amount`
- `vat_amount`
- `tourist_tax`
- `amountGross`

### 4. Fixed Conditional Actions

Changed from custom action names to standard actions:

- `show_vat_line` → `show`
- `show_tourist_tax_line` → `show`

### 5. Tenant-Specific Defaults

Each tenant has customized static field defaults:

**GoodwinSolutions:**

- `company_name`: "Jabaki a Goodwin Solutions Company"
- `company_vat`: "NL812613764B02"
- `company_coc`: "24352408"
- `contact_email`: "peter@jabaki.nl"

**PeterPrive:**

- `company_name`: "Peter Geers"
- `company_vat`: "" (empty)
- `company_coc`: "" (empty)
- `contact_email`: "peter@geers.nl"

## Verification

```sql
-- Verify all records have correct structure
SELECT
    id,
    administration,
    template_type,
    is_active,
    JSON_EXTRACT(field_mappings, '$.fields.company_name.source') as has_source,
    JSON_EXTRACT(field_mappings, '$.conditionals[0].action') as conditional_action
FROM tenant_template_config
WHERE template_type LIKE 'str_invoice%';
```

**Result:**

```
id  administration      template_type    is_active  has_source  conditional_action
5   GoodwinSolutions    str_invoice_en   1          "static"    "show"
4   GoodwinSolutions    str_invoice_nl   1          "static"    "show"
11  PeterPrive          str_invoice_en   1          "static"    "show"
10  PeterPrive          str_invoice_nl   1          "static"    "show"
```

✅ All records updated successfully!

## SQL Script

The update was performed using: `backend/sql/update_str_invoice_field_mappings.sql`

## Impact

### ✅ Benefits

1. **TemplateService Compatibility** - Field mappings now match TemplateService schema
2. **Proper Data Sourcing** - Clear distinction between database, static, and calculated fields
3. **Currency Formatting** - Automatic rounding for currency values
4. **Tenant Customization** - Each tenant has their own company information
5. **Standard Actions** - Conditionals use standard action names

### ⚠️ No Breaking Changes

- The route implementation has fallback to filesystem templates
- Existing functionality continues to work
- Database-driven templates are now properly supported

## Testing

To test the updated field mappings:

```bash
# Run integration tests
pytest backend/tests/integration/test_str_invoice_template_service.py -v

# Test with real booking
curl -X POST http://localhost:5000/api/str-invoice/generate-invoice \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "reservationCode": "<real_code>",
    "language": "nl"
  }'
```

## Files Created/Updated

1. ✅ `backend/sql/update_str_invoice_field_mappings.sql` - SQL update script
2. ✅ `backend/templates/html/str_invoice_field_mappings.json` - Reference JSON
3. ✅ `backend/str_invoice_field_mappings_validation.md` - Validation documentation
4. ✅ `backend/MYSQL_UPDATE_SUMMARY.md` - This summary

## Next Steps

1. ✅ MySQL database updated with correct field mappings
2. ✅ TemplateService integration complete
3. ⏳ Test invoice generation with real bookings
4. ⏳ Monitor for any issues in production
5. ⏳ Update other report types (tax forms) to use TemplateService

## Rollback Plan

If needed, the original field mappings can be restored from the database backup or by reverting the SQL script changes. However, the new structure is backward compatible with the route implementation.

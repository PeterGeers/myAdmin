# STR Invoice TemplateService Integration

## Summary

Updated STR invoice generation to use TemplateService with field mappings, following the Railway migration architecture pattern.

## Changes Made

### 1. Updated `backend/src/str_invoice_routes.py`

**Route**: `POST /generate-invoice`

**Changes**:

- Integrated TemplateService for template loading and field mapping application
- Added support for loading templates from database/Google Drive (with filesystem fallback)
- Implemented field mappings approach for placeholder replacement
- Maintained the generator pattern for complex sections (table_rows)

**Architecture Pattern**:

```python
# 1. Query booking data from database
# 2. Use str_invoice_generator to prepare data and generate table_rows
# 3. Try to load template metadata from database
# 4. If metadata exists, fetch template from Google Drive
# 5. If not, fallback to filesystem template
# 6. Apply field mappings using TemplateService
# 7. Return generated HTML
```

**Key Features**:

- **Database-first approach**: Tries to load template metadata from `tenant_template_config` table
- **Google Drive integration**: Fetches templates from tenant's Google Drive if configured
- **Filesystem fallback**: Falls back to local templates if database/Drive not configured
- **Field mappings**: Uses TemplateService's `apply_field_mappings()` method
- **Generator pattern**: Pre-generates complex sections (table_rows) using `str_invoice_generator`

### 2. Field Mappings Structure

The implementation uses field mappings as defined in the architecture:

```python
field_mappings = {
    'fields': {
        'company_name': {'path': 'company_name', 'format': 'text'},
        'net_amount': {'path': 'net_amount', 'format': 'currency'},
        'invoice_date': {'path': 'invoice_date', 'format': 'date'},
        'table_rows': {'path': 'table_rows', 'format': 'text'},
        # ... all other fields
    },
    'formatting': {
        'locale': 'nl_NL',  # or 'en_US'
        'currency': 'EUR',
        'date_format': 'DD-MM-YYYY',
        'number_decimals': 2
    }
}
```

### 3. Created Integration Test

**File**: `backend/tests/integration/test_str_invoice_template_service.py`

**Tests**:

- `test_str_invoice_with_template_service_and_field_mappings()` - Tests Dutch invoice with TemplateService
- `test_str_invoice_english_with_template_service()` - Tests English invoice with TemplateService

**Coverage**:

- TemplateService initialization
- Field mappings creation
- Template loading from filesystem
- Field mapping application
- HTML output verification
- Placeholder replacement verification

## Architecture Compliance

✅ **Follows Railway Migration Architecture**:

- Uses TemplateService for template management
- Supports field mappings from database
- Supports Google Drive template storage
- Maintains generator pattern for complex sections
- Provides filesystem fallback for development

✅ **Follows Hybrid Generation Approach**:

- Complex sections (table_rows) pre-generated by `report_generators/str_invoice_generator`
- Simple placeholders replaced by TemplateService
- Clean separation of concerns

✅ **Tenant-Specific**:

- Templates can be customized per tenant
- Stored in tenant's Google Drive
- Metadata in `tenant_template_config` table

## Migration Path

### Current State (Development)

- Templates loaded from filesystem: `backend/templates/html/str_invoice_{language}_template.html`
- Field mappings created dynamically in code
- Works without database configuration

### Future State (Production)

1. Upload templates to tenant's Google Drive
2. Store template metadata in `tenant_template_config` table:
   ```sql
   INSERT INTO tenant_template_config (
       administration, template_type, template_file_id, field_mappings, is_active
   ) VALUES (
       'GoodwinSolutions',
       'str_invoice_nl',
       '<google_drive_file_id>',
       '{"fields": {...}, "formatting": {...}}',
       TRUE
   );
   ```
3. Route automatically uses database/Drive templates
4. Filesystem templates remain as fallback

## Testing

### Manual Testing

```bash
# Test Dutch invoice
curl -X POST http://localhost:5000/api/str-invoice/generate-invoice \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "reservationCode": "ABC123",
    "language": "nl"
  }'

# Test English invoice
curl -X POST http://localhost:5000/api/str-invoice/generate-invoice \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "reservationCode": "ABC123",
    "language": "en"
  }'
```

### Automated Testing

```bash
# Run integration tests
pytest backend/tests/integration/test_str_invoice_template_service.py -v

# Run all STR invoice tests
pytest backend/tests -k str_invoice -v
```

## Related Files

- **Route**: `backend/src/str_invoice_routes.py`
- **Generator**: `backend/src/report_generators/str_invoice_generator.py`
- **TemplateService**: `backend/src/services/template_service.py`
- **Templates**: `backend/templates/html/str_invoice_{nl|en}_template.html`
- **Field Mappings Doc**: `backend/templates/html/STR_INVOICE_FIELD_MAPPINGS.md`
- **Tests**: `backend/tests/integration/test_str_invoice_template_service.py`

## Next Steps

1. ✅ Update STR invoice generation to use TemplateService (COMPLETED)
2. ⏳ Update tax form generation to use TemplateService (PENDING)
3. ⏳ Add output destination options (download, Google Drive, S3) (PENDING)
4. ⏳ Test all report types (PENDING)

## Notes

- The implementation maintains backward compatibility with existing tests
- Filesystem templates remain as fallback for development
- Database/Google Drive integration is optional and gracefully degrades
- Field mappings can be customized per tenant in the database
- The generator pattern ensures complex sections (table_rows) are properly handled
